<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shieldscrow | The Standard in Digital Trust</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* LUXURY THEME OVERRIDES */
        /* DEFAULT IS NOW LIGHT THEME */
        :root {
            --bg-color: #f4f4f5;
            --text-color: #18181b;
            --text-muted: #52525b;
            --panel-bg: rgba(255, 255, 255, 0.85);
            --panel-border: rgba(0, 0, 0, 0.1);
            --input-bg: rgba(0, 0, 0, 0.05);
            --input-border: rgba(0, 0, 0, 0.1);
            --accent-glow: rgba(0, 0, 0, 0.1);
            --btn-bg: #18181b;
            --btn-text: #ffffff;
            --dropdown-bg: #ffffff;
            --scrollbar-track: #f0f0f0;
            --scrollbar-thumb: #ccc;
            --toggle-icon: #18181b;
            --address-color: rgba(0,0,0,0.15);
        }

        /* DARK THEME OVERRIDES */
        [data-theme="dark"] {
            --bg-color: #050505;
            --text-color: #f5f5f5;
            --text-muted: #a3a3a3;
            --panel-bg: rgba(20, 20, 20, 0.6);
            --panel-border: rgba(255, 255, 255, 0.08);
            --input-bg: rgba(255, 255, 255, 0.03);
            --input-border: rgba(255, 255, 255, 0.1);
            --accent-glow: rgba(255, 255, 255, 0.4);
            --btn-text: #000;
            --btn-bg: #fff;
            --dropdown-bg: #0a0a0a;
            --scrollbar-track: #000;
            --scrollbar-thumb: #333;
            --toggle-icon: #f5f5f5;
            --address-color: rgba(255,255,255,0.15);
        }

        /* GLOBAL TRANSITIONS */
        body, .glass-panel, .luxury-input, button, input, select, .premium-glass {
            transition: background-color 0.5s cubic-bezier(0.4, 0, 0.2, 1), 
                        color 0.5s cubic-bezier(0.4, 0, 0.2, 1), 
                        border-color 0.5s cubic-bezier(0.4, 0, 0.2, 1),
                        box-shadow 0.5s ease;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            overflow-x: hidden; 
        }

        h1, h2, h3, .serif { font-family: 'Playfair Display', serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Minimal Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--scrollbar-track); }
        ::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); }

        /* Standard Glass Panel */
        .glass-panel {
            background: var(--panel-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--panel-border);
            box-shadow: 0 20px 40px rgba(0,0,0,0.05);
        }

        /* REVERTED: PREMIUM GLASS (Clean Style) */
        .premium-glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(40px) saturate(150%);
            -webkit-backdrop-filter: blur(40px) saturate(150%);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 
                0 40px 100px -10px rgba(0, 0, 0, 0.5),
                inset 0 0 0 1px rgba(255, 255, 255, 0.02);
            border-radius: 24px;
        }

        /* Elegant Inputs */
        .luxury-input {
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            color: var(--text-color);
        }
        .luxury-input:focus {
            background: var(--input-bg);
            border-color: var(--text-muted);
            outline: none;
            box-shadow: 0 0 0 2px rgba(125, 125, 125, 0.1);
        }
        
        .luxury-input.error {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.05);
        }

        /* Input Styles for Tech Card */
        .tech-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: inherit;
            transition: all 0.3s ease;
        }
        .tech-input:focus {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.3);
            outline: none;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.05);
        }

        /* ANIMATIONS */
        .fade-in { animation: fadeIn 0.8s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .modal-enter { animation: fadeIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .toast-enter { animation: slideDown 0.4s ease-out forwards; }
        @keyframes slideDown { from { transform: translate(-50%, -100%); opacity: 0; } to { transform: translate(-50%, 20px); opacity: 1; } }
        
        /* NEW PAGE TRANSITIONS */
        .slide-up-enter {
            animation: slideUpReveal 1s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
            opacity: 0;
            transform: translateY(100vh);
        }
        @keyframes slideUpReveal {
            from { transform: translateY(100vh); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* LIVE TICKER ANIMATION */
        .fade-slide-up {
            animation: fadeSlideUp 0.5s ease-out forwards;
        }
        @keyframes fadeSlideUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* CRYPTO BACKGROUND ANIMATION */
        .crypto-bg-container {
            position: fixed; 
            top: 0; left: 0; width: 100%; height: 100%;
            overflow: hidden;
            z-index: -1; /* Behind everything */
            pointer-events: none;
        }
        .crypto-floater {
            position: absolute;
            bottom: -100px; /* Start further down */
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        @keyframes floatUp {
            0% { transform: translateY(0) rotate(0deg); opacity: 0; }
            10% { opacity: var(--target-opacity, 0.3); } 
            90% { opacity: var(--target-opacity, 0.3); }
            100% { transform: translateY(-120vh) rotate(20deg); opacity: 0; }
        }
        
        /* DATA STREAM BACKGROUND (For Auth Page) */
        .data-stream-container {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            overflow: hidden;
            z-index: 0;
            opacity: 0.4; /* Calmer opacity */
        }
        .data-string {
            position: absolute;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: var(--text-muted); /* Adapts to theme */
            white-space: nowrap;
            user-select: none;
            will-change: transform, opacity;
            pointer-events: none;
        }
        @keyframes drift {
            0% { transform: translate(0, 0); opacity: 0; }
            10% { opacity: 0.4; }
            90% { opacity: 0.4; }
            100% { transform: translate(var(--mx), var(--my)); opacity: 0; }
        }

        /* GLOWING BUTTON (Adapts to theme) */
        .glow-button {
            border: 1px solid var(--text-color);
            padding: 1em 3em;
            color: var(--bg-color);
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            cursor: pointer;
            background-color: var(--text-color);
            border-radius: 0.5em;
            outline: none;
            box-shadow: 0 0 1em 0.25em var(--text-color), 0 0 4em 1em var(--accent-glow);
            text-shadow: 0 0 0.5em var(--text-color);
            position: relative;
            width: auto;
            display: inline-block;
        }
        .glow-button:hover {
            box-shadow: 0 0 1em 0.5em var(--text-color), 0 0 4em 2em var(--accent-glow);
        }

        .pulse-ring { animation: ringPulse 2s infinite; }
        @keyframes ringPulse { 0% { transform: scale(0.8); opacity: 0.5; } 100% { transform: scale(1.2); opacity: 0; } }
        .icon-bounce { animation: gentleBounce 2s infinite; }
        @keyframes gentleBounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        
        /* THEME TOGGLE ANIMATION */
        .theme-toggle-icon {
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        .theme-toggle-btn:active .theme-toggle-icon {
            transform: rotate(180deg) scale(0.8);
        }

        /* COIN TRANSITION STYLES (60FPS Optimized) */
        .coin-transition-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .coin-transition-container.animating {
            opacity: 1;
        }
        .coin-mover {
            position: absolute;
            will-change: transform; /* Hint to browser for GPU acceleration */
        }

        .gold-coin {
            width: 250px;
            height: 250px;
            background: radial-gradient(ellipse at center, #ffd700 0%, #b8860b 100%);
            border-radius: 50%;
            box-shadow: 
                0 0 60px rgba(255, 215, 0, 0.6), 
                inset 0 0 20px rgba(255, 255, 255, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 120px;
            color: #74540d;
            border: 6px solid #DAA520;
            will-change: transform;
        }
        .gold-coin::after {
            content: '';
            position: absolute;
            top: 8px; left: 8px; right: 8px; bottom: 8px;
            border: 2px dashed #976d08;
            border-radius: 50%;
            opacity: 0.6;
        }
        .animating .coin-mover {
            animation: slideAcross 1.5s cubic-bezier(0.2, 0.0, 0.2, 1) forwards;
        }
        .animating .gold-coin {
            animation: spin3d 0.8s linear infinite;
        }
        @keyframes slideAcross {
            0% { transform: translateX(120vw) scale(0.5); }
            100% { transform: translateX(-120vw) scale(0.5); }
        }
        @keyframes spin3d {
            0% { transform: rotateY(0deg); }
            100% { transform: rotateY(360deg); }
        }
        
        /* Chat Widget */
        .chat-window-enter { animation: slideUpChat 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideUpChat { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>

    <!-- 2. FIREBASE MODULES (Setup for Global Access) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, doc, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Attach modules to window so the Babel script can see them
        window.FirebaseModules = {
            initializeApp,
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged,
            getFirestore,
            collection,
            addDoc,
            updateDoc,
            doc,
            onSnapshot,
            getDocs
        };
    </script>
</head>
<body>
    <div id="root"></div>

    <!-- 3. MAIN APPLICATION CODE -->
    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // Access Firebase modules from the global window object
        const { 
            initializeApp, 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged,
            getFirestore, 
            collection, 
            addDoc, 
            updateDoc, 
            doc, 
            onSnapshot, 
            getDocs 
        } = window.FirebaseModules;

        // --- CONFIGURATION ---
        const AUTO_REFUND_TIME_MS = 2 * 60 * 60 * 1000; // 2 HOURS
        
        const DEFAULT_WALLETS = {
            "Ethereum (ETH)": "0x8e705Ee7E8d22538cDbB25C77881994fb722a0fa",
            "Bitcoin (Taproot)": "bc1p44ukqjccnjjrwmc93zcy3rjufylaly2vvt67sgm0xyn0upjsy4hszxrxql",
            "Solana (SOL)": "BqWUrn8B7B59o6EivE7zJ9iqhpvF9wJkF7SVezi6u6gs",
            "Sui (SUI)": "0xb340ac0f753e4d0190e138851d35e17032eff983e6fb4df4a8a9ae118b21d6ce",
            "Polygon (MATIC)": "0x8e705Ee7E8d22538cDbB25C77881994fb722a0fa"
        };

        // --- FIREBASE INIT ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        let app, auth, firestore;
        if (firebaseConfig.apiKey) {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            firestore = getFirestore(app);
        } else {
            console.warn("Firebase config not found.");
        }

        // --- DATABASE HELPERS (Async) ---
        const dbHelper = {
            registerUser: async (userData) => {
                if (!firestore) return null;
                try {
                    // Generate unique handle
                    const randomSuffix = Math.floor(10000 + Math.random() * 90000);
                    const uniqueHandle = '@' + userData.name.toLowerCase().replace(/\s/g, '') + randomSuffix;
                    
                    await addDoc(collection(firestore, 'artifacts', appId, 'public', 'data', 'users'), {
                        ...userData,
                        uniqueHandle,
                        createdAt: Date.now()
                    });
                    return { ...userData, uniqueHandle };
                } catch(e) { console.error(e); return null; }
            },
            authenticateUser: async (name, password) => {
                if (!firestore) return null;
                try {
                    const snap = await getDocs(collection(firestore, 'artifacts', appId, 'public', 'data', 'users'));
                    const users = snap.docs.map(d => d.data());
                    return users.find(u => u.name === name && u.password === password);
                } catch(e) { console.error(e); return null; }
            },
            getAllUsers: async () => {
                if (!firestore) return [];
                try {
                    const snap = await getDocs(collection(firestore, 'artifacts', appId, 'public', 'data', 'users'));
                    return snap.docs.map(d => d.data());
                } catch(e) { console.error(e); return []; }
            },
            createTransaction: async (tx) => {
                if (!firestore) return;
                try {
                    await addDoc(collection(firestore, 'artifacts', appId, 'public', 'data', 'transactions'), {
                        ...tx,
                        dateMs: Date.now()
                    });
                } catch(e) { console.error(e); }
            },
            updateTransaction: async (id, updates) => {
                if (!firestore) return;
                try {
                    const docRef = doc(firestore, 'artifacts', appId, 'public', 'data', 'transactions', id);
                    await updateDoc(docRef, updates);
                } catch(e) { console.error(e); }
            },
            sendMessage: async (txId, senderHandle, text) => {
                if (!firestore) return;
                try {
                    await addDoc(collection(firestore, 'artifacts', appId, 'public', 'data', 'messages'), {
                        transactionId: txId,
                        sender: senderHandle,
                        text,
                        timestamp: Date.now()
                    });
                } catch(e) { console.error(e); }
            }
        };

        // --- COMPONENTS ---

        const BlockchainBackground = () => {
            const nodes = useMemo(() => Array.from({ length: 20 }).map((_, i) => ({
                left: `${Math.random() * 100}%`,
                animationDuration: `${15 + Math.random() * 15}s`,
                animationDelay: `-${Math.random() * 20}s`,
                width: `${2 + Math.random() * 4}px`,
                height: `${2 + Math.random() * 4}px`,
            })), []);

            return (
                <div className="blockchain-bg">
                    {nodes.map((style, i) => <div key={i} className="node" style={style} />)}
                </div>
            );
        };

        // --- NEW CRYPTO BACKGROUND COMPONENT (For Create Page) ---
        const CryptoBackground = () => {
            // ONLY ICONS, NO TEXT. COLORS ADDED.
            const symbols = [
                { val: 'ph-currency-btc', color: '#F7931A' }, // Bitcoin Orange
                { val: 'ph-currency-eth', color: '#627EEA' }, // Ethereum Blue
                { val: 'ph-currency-dollar', color: '#26A17B' }, // USDT Green
                { val: 'ph-coins', color: '#CCAC00' }, // Generic Gold
                { val: 'ph-wallet', color: '#A020F0' }, // Wallet Purple
            ];

            const items = useMemo(() => Array.from({ length: 25 }).map((_, i) => {
                const symbol = symbols[i % symbols.length];
                return {
                    ...symbol,
                    left: `${Math.random() * 100}%`,
                    animationDuration: `${15 + Math.random() * 20}s`,
                    animationDelay: `-${Math.random() * 20}s`,
                    size: `${24 + Math.random() * 40}px`,
                    opacity: 0.6 + Math.random() * 0.3 
                };
            }), []);

            return (
                <div className="crypto-bg-container">
                    {items.map((item, i) => (
                        <div key={i} className="crypto-floater" style={{
                            left: item.left,
                            animation: `floatUp ${item.animationDuration} linear infinite`,
                            animationDelay: item.animationDelay,
                            fontSize: item.size,
                            color: item.color,
                            opacity: item.opacity,
                            '--target-opacity': item.opacity
                        }}>
                            <i className={`ph-fill ${item.val}`}></i>
                        </div>
                    ))}
                </div>
            );
        };

        // --- REVERTED: FIXED STRINGS DATA STREAM (Calmer background) ---
        const CryptoDataBackground = () => {
            const strings = [
                "0x71C7656EC7ab88b098defB751B7401B5f6d8976F",
                "bc1qjlpa9z6lehkfyqltmz7jf494uek02hn3cppsm7",
                "0x8e705Ee7E8d22538cDbB25C77881994fb722a0fa",
                "9372c360-3238-4220-ad68-0775d0342555",
                "CONNECTING_TO_MAINNET...",
                "VERIFYING_BLOCK_HASH...",
                "SIGNING_TRANSACTION...",
                "ENCRYPTING_PAYLOAD...",
                "ESTABLISHING_SECURE_TUNNEL...",
            ];

            const items = useMemo(() => Array.from({ length: 40 }).map((_, i) => {
                const str = strings[Math.floor(Math.random() * strings.length)];
                return {
                    val: str,
                    top: `${Math.random() * 100}%`,
                    left: `${Math.random() * 100}%`,
                    duration: `${20 + Math.random() * 30}s`,
                    delay: `-${Math.random() * 20}s`,
                    mx: `${(Math.random() - 0.5) * 200}px`,
                    my: `${(Math.random() - 0.5) * 200}px`
                };
            }), []);

            return (
                <div className="data-stream-container">
                    {items.map((item, i) => (
                        <div key={i} className="data-string" style={{
                            top: item.top,
                            left: item.left,
                            animation: `drift ${item.duration} linear infinite`,
                            animationDelay: item.delay,
                            '--mx': item.mx,
                            '--my': item.my
                        }}>
                            {item.val}
                        </div>
                    ))}
                    {/* Add some random floating icons for the "random things" feel */}
                    <div className="absolute top-1/4 left-1/4 opacity-10 animate-pulse text-6xl text-[var(--text-color)]"><i className="ph ph-currency-btc"></i></div>
                    <div className="absolute bottom-1/3 right-1/4 opacity-10 animate-bounce text-6xl text-[var(--text-color)]"><i className="ph ph-currency-eth"></i></div>
                </div>
            );
        };

        const ThemeToggle = () => {
            const [theme, setTheme] = useState('light'); 
            useEffect(() => {
                const savedTheme = localStorage.getItem('theme') || 'light'; 
                setTheme(savedTheme);
                document.documentElement.setAttribute('data-theme', savedTheme);
            }, []);
            const toggleTheme = () => {
                const nextTheme = theme === 'dark' ? 'light' : 'dark';
                setTheme(nextTheme);
                document.documentElement.setAttribute('data-theme', nextTheme);
                localStorage.setItem('theme', nextTheme);
            };
            return (
                <button onClick={toggleTheme} className="theme-toggle-btn w-8 h-8 rounded-full flex items-center justify-center border border-[var(--text-muted)] hover:border-[var(--text-color)] text-[var(--text-muted)] hover:text-[var(--text-color)] transition-all" title={`Switch to ${theme === 'dark' ? 'Light' : 'Dark'} Mode`}><i className={`theme-toggle-icon ph ${theme === 'dark' ? 'ph-sun' : 'ph-moon'} text-lg`}></i></button>
            );
        };

        // --- LIVE ACTIVITY TICKER COMPONENT ---
        const LiveActivityTicker = () => {
            const [activity, setActivity] = useState(null);
            
            const NAMES = [
                "Rahul", "Priya", "Amit", "Sneha", "Vikram", "Anjali", "Rohan", "Meera", "Suresh", "Kavita",
                "Ahmed", "Fatima", "Bilal", "Zainab", "Omar", "Ayesha", "Hassan", "Sana", "Yusuf", "Hira",
                "John", "Sarah", "Mike", "Emily", "David", "Jessica", "Robert", "Olivia",
                "Wei", "Li", "Hiro", "Yuki", "Jin", "Soo",
                "Carlos", "Maria", "Jose", "Sofia"
            ];
            
            const ACTIONS = ["secured", "released", "deposited"];
            const ASSETS = ["BTC", "ETH", "USDT", "SOL", "USDC"];

            useEffect(() => {
                const generateActivity = () => {
                    const sender = NAMES[Math.floor(Math.random() * NAMES.length)];
                    let receiver = NAMES[Math.floor(Math.random() * NAMES.length)];
                    while(receiver === sender) receiver = NAMES[Math.floor(Math.random() * NAMES.length)]; 
                    
                    const amount = (Math.random() * 2 + 0.1).toFixed(4);
                    const asset = ASSETS[Math.floor(Math.random() * ASSETS.length)];
                    const action = ACTIONS[Math.floor(Math.random() * ACTIONS.length)];
                    
                    let text = "";
                    if (action === "secured") text = `${sender} secured ${amount} ${asset} for ${receiver}`;
                    else if (action === "released") text = `Escrow released ${amount} ${asset} to ${receiver}`;
                    else text = `${sender} deposited ${amount} ${asset} into Vault`;

                    setActivity({ id: Date.now(), text, type: action });
                };

                generateActivity(); // Initial run
                const interval = setInterval(generateActivity, 4000); // New activity every 4 seconds
                return () => clearInterval(interval);
            }, []);

            if (!activity) return null;

            return (
                <div className="w-full flex justify-center mb-6">
                    <div key={activity.id} className="fade-slide-up glass-panel px-6 py-2 rounded-full border border-[var(--panel-border)] flex items-center gap-3 shadow-lg">
                        <div className={`w-2 h-2 rounded-full ${activity.type === 'secured' ? 'bg-blue-400' : activity.type === 'released' ? 'bg-green-400' : 'bg-yellow-400'} animate-pulse`}></div>
                        <span className="text-xs font-mono text-[var(--text-color)] tracking-wide">
                            <span className="font-bold text-[var(--text-muted)]">LIVE:</span> {activity.text}
                        </span>
                    </div>
                </div>
            );
        };

        const CustomSelect = ({ options, value, onChange, label }) => {
            const [isOpen, setIsOpen] = useState(false);
            return (
                <div className="relative w-full">
                    {label && <label className="block text-xs font-bold uppercase text-[var(--text-muted)] mb-3">{label}</label>}
                    <div className="w-full luxury-input rounded p-4 cursor-pointer flex justify-between items-center bg-[var(--input-bg)]" onClick={() => setIsOpen(!isOpen)}>
                        <span className="font-mono text-sm">{value}</span>
                        <i className={`ph ph-caret-down text-[var(--text-muted)] transition-transform duration-300 ${isOpen ? 'rotate-180' : ''}`}></i>
                    </div>
                    {isOpen && (
                        <div className="absolute top-full left-0 w-full mt-2 glass-panel border border-[var(--panel-border)] rounded-lg shadow-2xl z-50 max-h-60 overflow-y-auto">
                            {options.map((opt) => (
                                <div key={opt} className={`p-3 hover:bg-[var(--input-bg)] cursor-pointer text-sm font-mono transition-colors border-b border-[var(--panel-border)] ${value === opt ? 'font-bold text-[var(--text-color)]' : 'text-[var(--text-muted)]'}`} onClick={() => { onChange(opt); setIsOpen(false); }}>{opt}</div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // --- NEW LOGO COMPONENT ---
        const Logo = ({ size = "md" }) => {
            const sizeClasses = size === "lg" ? "w-32 h-32" : "w-12 h-12";
            const fontSize = size === "lg" ? "text-5xl" : "text-xl";
            
            return (
                <div className={`${sizeClasses} relative flex items-center justify-center`}>
                    {/* Fallback Logo (Code Generated) */}
                    <div className="absolute inset-0 w-full h-full flex items-center justify-center bg-transparent">
                        <svg viewBox="0 0 100 100" className="w-full h-full drop-shadow-[0_0_10px_rgba(255,215,0,0.3)]">
                            <defs>
                                <linearGradient id="goldGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" stopColor="#FDB931" />
                                    <stop offset="50%" stopColor="#FFD700" />
                                    <stop offset="100%" stopColor="#B8860B" />
                                </linearGradient>
                            </defs>
                            {/* Shield Outline */}
                            <path d="M50 5 L90 25 L90 55 Q50 95 10 55 L10 25 Z" fill="none" stroke="url(#goldGradient)" strokeWidth="3" />
                            {/* Inner Border */}
                            <path d="M50 12 L83 28 L83 55 Q50 88 17 55 L17 28 Z" fill="none" stroke="url(#goldGradient)" strokeWidth="1" opacity="0.7" />
                            {/* Text */}
                            <text x="50" y="62" textAnchor="middle" fill="url(#goldGradient)" fontFamily="serif" fontSize="35" fontWeight="bold">SE</text>
                        </svg>
                    </div>
                    {/* User Uploaded Logo - overlays if exists */}
                    <img 
                        src="se logo.jpg" 
                        className="absolute inset-0 w-full h-full object-contain z-10" 
                        onError={(e) => e.target.style.display = 'none'} 
                        alt="Shieldscrow" 
                    />
                </div>
            );
        };

        const CoinTransition = ({ isActive }) => (
            <div className={`coin-transition-container ${isActive ? 'animating' : ''}`}>
                <div className="coin-mover">
                    <div className="gold-coin"><i className="ph-fill ph-currency-btc"></i></div>
                </div>
            </div>
        );

        const ActionOverlay = ({ type, text, status, progress }) => (
            <div className="fixed inset-0 bg-black/95 z-[200] flex flex-col items-center justify-center modal-enter">
                <div className="relative w-48 h-48 mb-8 flex items-center justify-center">
                    {status === 'processing' || status === 'uploading' ? (
                        <>
                            <div className="absolute inset-0 border-2 border-white/10 rounded-full pulse-ring"></div>
                            <div className="absolute inset-4 border border-white/20 rounded-full"></div>
                            <div className="text-6xl text-white icon-bounce">
                                {type === 'deposit' && <i className="ph ph-coins text-yellow-400"></i>}
                                {type === 'deliver' && <i className="ph ph-paper-plane-tilt text-blue-400"></i>}
                                {type === 'verify' && <i className="ph ph-shield-check text-green-400"></i>}
                                {type === 'ai' && <i className="ph ph-sparkle text-purple-400"></i>}
                                {type === 'upload' && <i className="ph ph-upload-simple text-blue-400"></i>}
                            </div>
                        </>
                    ) : (
                        <div className="flex items-center justify-center">
                            <svg className="checkmark-circle" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                                <circle className="checkmark-circle" cx="26" cy="26" r="25" fill="none"/>
                                <path className="checkmark-check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                            </svg>
                        </div>
                    )}
                </div>
                <h2 className="text-2xl font-serif text-white tracking-[0.2em] uppercase mb-2 text-center px-4">{text}</h2>
                {status === 'uploading' && <div className="w-64 mt-6"><div className="w-full h-1 bg-white/10 rounded-full overflow-hidden"><div className="h-full bg-emerald-400 transition-all duration-300 ease-out" style={{ width: `${progress}%` }}></div></div><div className="text-center mt-3 font-mono text-emerald-400 text-xs tracking-widest">{progress < 100 ? `${Math.round(progress)}%` : 'COMPLETE'}</div></div>}
                {status === 'processing' && <div className="w-48 h-1 bg-white/10 rounded-full overflow-hidden mt-4"><div className="h-full bg-white w-1/2 animate-[shimmer_1s_infinite]"></div></div>}
            </div>
        );

        const TimerDisplay = ({ fundedAt, isCompact }) => {
            const [timeLeft, setTimeLeft] = useState(null);
            useEffect(() => {
                const updateTimer = () => {
                    if (!fundedAt) return;
                    const elapsed = Date.now() - fundedAt;
                    const remaining = AUTO_REFUND_TIME_MS - elapsed;
                    if (remaining <= 0) { setTimeLeft("Expired"); } 
                    else {
                        const h = Math.floor(remaining / (1000 * 60 * 60));
                        const m = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                        const s = Math.floor((remaining % (1000 * 60)) / 1000);
                        setTimeLeft(`${h}h ${m}m ${s}s`);
                    }
                };
                updateTimer();
                const i = setInterval(updateTimer, 1000);
                return () => clearInterval(i);
            }, [fundedAt]);
            if (!timeLeft || timeLeft === "Expired") return null;
            return (
                <div className={`flex items-center gap-2 text-orange-400 ${isCompact ? '' : 'absolute top-4 left-4'}`}>
                    <i className="ph ph-timer animate-pulse"></i>
                    <span className="text-xs font-mono font-bold tracking-widest">{timeLeft}</span>
                </div>
            );
        };

        // --- CHAT SYSTEM ---
        const ChatWindow = ({ tx, currentUser, onClose }) => {
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState("");
            const scrollRef = useRef(null);

            useEffect(() => {
                if (!firestore) return;
                const unsubscribe = onSnapshot(collection(firestore, 'artifacts', appId, 'public', 'data', 'messages'), (snapshot) => {
                    const allMsgs = snapshot.docs.map(doc => doc.data());
                    // Filter in memory as per constraints
                    const txMsgs = allMsgs.filter(m => m.transactionId === tx.id).sort((a, b) => a.timestamp - b.timestamp);
                    setMessages(txMsgs);
                    if(scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
                });
                return () => unsubscribe();
            }, [tx.id]);

            const send = async () => {
                if(!input.trim()) return;
                await dbHelper.sendMessage(tx.id, currentUser.uniqueHandle, input);
                setInput("");
            };

            return (
                <div className="fixed bottom-20 right-6 w-80 md:w-96 h-[500px] glass-panel border border-[var(--panel-border)] rounded-xl flex flex-col shadow-2xl z-50 chat-window-enter font-sans">
                    {/* Header with Live Timer */}
                    <div className="p-4 border-b border-[var(--panel-border)] bg-[var(--panel-bg)] flex justify-between items-center">
                        <div>
                            <div className="text-xs font-bold text-[var(--text-color)] uppercase">{tx.title}</div>
                            {tx.status === 'funded' ? (
                                <div className="text-[10px] mt-1 flex items-center gap-1">
                                    <span className="text-[var(--text-muted)]">Auto-Refund In:</span>
                                    <TimerDisplay fundedAt={tx.fundedAt} isCompact={true} />
                                </div>
                            ) : <div className="text-[10px] text-[var(--text-muted)] uppercase tracking-wide mt-1">{tx.status}</div>}
                        </div>
                        <button onClick={onClose} className="text-[var(--text-muted)] hover:text-white"><i className="ph ph-x text-lg"></i></button>
                    </div>

                    {/* Messages Area */}
                    <div className="flex-1 overflow-y-auto p-4 space-y-3" ref={scrollRef}>
                        {messages.length === 0 && <div className="text-center text-[var(--text-muted)] text-xs italic mt-10">Secure channel established.<br/>Negotiate delivery details here.</div>}
                        {messages.map((m, i) => {
                            const isMe = m.sender === currentUser.uniqueHandle;
                            return (
                                <div key={i} className={`flex flex-col ${isMe ? 'items-end' : 'items-start'}`}>
                                    <div className={`max-w-[85%] p-3 rounded-xl text-xs ${isMe ? 'bg-[var(--text-color)] text-[var(--bg-color)]' : 'bg-[var(--input-bg)] text-[var(--text-color)] border border-[var(--panel-border)]'}`}>
                                        {m.text}
                                    </div>
                                    <div className="text-[9px] text-[var(--text-muted)] mt-1 opacity-50">{m.sender}</div>
                                </div>
                            )
                        })}
                    </div>

                    {/* Input Area */}
                    <div className="p-3 border-t border-[var(--panel-border)] bg-[var(--panel-bg)] flex gap-2">
                        <input 
                            className="flex-1 bg-transparent text-xs text-[var(--text-color)] outline-none placeholder-[var(--text-muted)]" 
                            placeholder="Type a secure message..."
                            value={input}
                            onChange={e => setInput(e.target.value)}
                            onKeyPress={e => e.key === 'Enter' && send()}
                        />
                        <button onClick={send} className="text-[var(--text-color)] hover:text-emerald-400"><i className="ph-fill ph-paper-plane-right text-lg"></i></button>
                    </div>
                </div>
            );
        };

        // --- CORE MODALS ---

        const DepositModal = ({ tx, onClose, adminWallets, setProcessingAction, showNotification }) => {
            const walletAddress = adminWallets[tx.currency] || "Address Not Found";
            const handleCopy = () => {
                if (navigator.clipboard) { navigator.clipboard.writeText(walletAddress); showNotification("Address Copied"); } 
                else { const t = document.createElement("textarea"); t.value = walletAddress; document.body.appendChild(t); t.select(); document.execCommand('copy'); document.body.removeChild(t); showNotification("Address Copied"); }
            };
            const handleConfirm = () => {
                setProcessingAction({ type: 'deposit', text: 'Verifying Blockchain...', status: 'processing' });
                setTimeout(async () => {
                    setProcessingAction({ type: 'deposit', text: 'Funds Secured', status: 'success' });
                    await dbHelper.updateTransaction(tx.id, { status: 'funded', fundedAt: Date.now() });
                    setTimeout(() => { setProcessingAction(null); onClose(); }, 1500);
                }, 3000);
            };
            return (
                <div className="fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4 modal-enter">
                    <div className="glass-panel max-w-md w-full p-8 rounded-xl relative">
                        <button onClick={onClose} className="absolute top-4 right-4 text-[var(--text-muted)] hover:text-white"><i className="ph ph-x text-xl"></i></button>
                        <h3 className="text-2xl font-serif mb-2">Secure Deposit</h3>
                        <p className="text-xs text-[var(--text-muted)] mb-6 uppercase tracking-widest">Send exact amount to the Vault</p>
                        <div className="bg-white p-4 rounded-lg mx-auto w-48 h-48 mb-6 flex items-center justify-center"><img src={`https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${walletAddress}`} alt="QR" className="opacity-90" /></div>
                        <div className="mb-6"><label className="text-[10px] uppercase font-bold text-[var(--text-muted)]">Vault Address ({tx.currency})</label><div onClick={handleCopy} className="luxury-input p-3 rounded mt-1 flex justify-between items-center cursor-pointer hover:border-[var(--text-color)] transition-colors group"><span className="font-mono text-xs truncate mr-2">{walletAddress}</span><i className="ph ph-copy text-[var(--text-muted)] group-hover:text-white"></i></div></div>
                        <div className="flex justify-between items-center mb-6 text-sm"><span className="text-[var(--text-muted)]">Amount Due:</span><span className="font-mono font-bold text-emerald-400">{tx.amount}</span></div>
                        <button onClick={handleConfirm} className="glow-button w-full text-center">I Have Sent The Funds</button>
                    </div>
                </div>
            );
        };

        const DeliverModal = ({ tx, onClose, onDeliver }) => {
            const [link, setLink] = useState('');
            return (
                <div className="fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4 modal-enter">
                    <div className="glass-panel max-w-md w-full p-8 rounded-xl relative">
                        <button onClick={onClose} className="absolute top-4 right-4 text-[var(--text-muted)] hover:text-white"><i className="ph ph-x text-xl"></i></button>
                        <h3 className="text-2xl font-serif mb-2">Secure Delivery</h3>
                        <p className="text-xs text-[var(--text-muted)] mb-6 uppercase tracking-widest">Provide access to the asset</p>
                        <div className="space-y-4">
                            <div><label className="text-[10px] uppercase font-bold text-[var(--text-muted)]">Download Link / Access Credentials</label><textarea className="w-full luxury-input p-4 rounded mt-2 h-32 font-mono text-sm resize-none" placeholder="Paste Google Drive link, account credentials, or instructions here..." onChange={(e) => setLink(e.target.value)}></textarea></div>
                            <div className="text-[10px] text-[var(--text-muted)] flex gap-2"><i className="ph ph-lock-key text-emerald-400"></i><span>This information is encrypted and only visible to the buyer after funds are secured.</span></div>
                            <button onClick={() => onDeliver(link)} className="glow-button w-full text-center">Encrypt & Send</button>
                        </div>
                    </div>
                </div>
            );
        };

        const LandingPage = ({ setView }) => (
            <div className="min-h-screen flex flex-col items-center justify-center text-center px-6 slide-up-enter relative overflow-hidden">
                <div className="absolute inset-0 z-0 opacity-30 pointer-events-none bg-[url('https://images.unsplash.com/photo-1642104704074-907c0698cbd9?auto=format&fit=crop&q=80&w=2532')] bg-cover bg-center mix-blend-overlay"></div>
                <div className="relative z-10 max-w-5xl w-full flex flex-col items-center">
                    <div className="mb-8 relative group cursor-pointer" onClick={() => setView('dashboard')}>
                        <div className="absolute -inset-4 bg-emerald-500/20 rounded-full blur-xl group-hover:opacity-100 transition duration-1000 opacity-0"></div>
                        <Logo size="lg" />
                    </div>
                    <div className="inline-flex items-center gap-2 px-4 py-2 rounded-full border border-[var(--panel-border)] mb-8 bg-[var(--input-bg)] backdrop-blur-md"><span className="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span><span className="text-xs font-bold uppercase tracking-widest">Live on Mainnet</span></div>
                    <h1 className="text-5xl md:text-8xl font-serif mb-6 leading-tight text-shadow-lg">Trusted.<br/><span className="italic font-serif text-[var(--text-muted)]">Private. Secure.</span></h1>
                    <p className="text-lg text-[var(--text-muted)] mb-12 max-w-2xl mx-auto">Shieldscrow is the premier escrow service for high-value digital assets. Protecting over $50M in volume.</p>
                    <button onClick={() => setView('dashboard')} className="glow-button">Start Transaction</button>
                    
                    {/* NEW ABOUT SECTION */}
                    <div className="mt-24 w-full text-left">
                        <h2 className="text-3xl font-serif text-center mb-10">How Shieldscrow Works</h2>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div className="glass-panel p-8 rounded-xl hover:border-emerald-500/30 transition duration-500 flex flex-col items-center text-center">
                                <div className="w-12 h-12 bg-emerald-900/20 rounded-lg flex items-center justify-center mb-4 text-emerald-400"><i className="ph ph-handshake text-2xl"></i></div>
                                <h3 className="font-serif text-xl mb-2">1. Agreement</h3>
                                <p className="text-sm text-[var(--text-muted)]">Buyer and Seller agree on terms and initialize the smart contract. A secure handle is required for both parties.</p>
                            </div>
                            <div className="glass-panel p-8 rounded-xl hover:border-yellow-500/30 transition duration-500 flex flex-col items-center text-center">
                                <div className="w-12 h-12 bg-yellow-900/20 rounded-lg flex items-center justify-center mb-4 text-yellow-400"><i className="ph ph-wallet text-2xl"></i></div>
                                <h3 className="font-serif text-xl mb-2">2. Funds Deposit</h3>
                                <p className="text-sm text-[var(--text-muted)]">The Buyer deposits the agreed-upon crypto into the Shieldscrow multi-sig vault. Funds are verified on the blockchain.</p>
                            </div>
                            <div className="glass-panel p-8 rounded-xl hover:border-blue-500/30 transition duration-500 flex flex-col items-center text-center">
                                <div className="w-12 h-12 bg-blue-900/20 rounded-lg flex items-center justify-center mb-4 text-blue-400"><i className="ph ph-package text-2xl"></i></div>
                                <h3 className="font-serif text-xl mb-2">3. Secure Delivery</h3>
                                <p className="text-sm text-[var(--text-muted)]">The Seller delivers the digital asset (domain, code, NFT access) knowing the payment is already secured.</p>
                            </div>
                            <div className="glass-panel p-8 rounded-xl hover:border-purple-500/30 transition duration-500 flex flex-col items-center text-center">
                                <div className="w-12 h-12 bg-purple-900/20 rounded-lg flex items-center justify-center mb-4 text-purple-400"><i className="ph ph-eye text-2xl"></i></div>
                                <h3 className="font-serif text-xl mb-2">4. Buyer Inspection</h3>
                                <p className="text-sm text-[var(--text-muted)]">The Buyer inspects the asset within the agreed timeframe. Both parties communicate via the secure chat channel.</p>
                            </div>
                            <div className="glass-panel p-8 rounded-xl hover:border-red-500/30 transition duration-500 flex flex-col items-center text-center">
                                <div className="w-12 h-12 bg-red-900/20 rounded-lg flex items-center justify-center mb-4 text-red-400"><i className="ph ph-hand-tap text-2xl"></i></div>
                                <h3 className="font-serif text-xl mb-2">5. Release or Refund</h3>
                                <p className="text-sm text-[var(--text-muted)]">If approved, funds are released instantly to the Seller. If rejected, funds are automatically refunded to the Buyer after dispute resolution.</p>
                            </div>
                            <div className="glass-panel p-8 rounded-xl hover:border-blue-500/30 transition duration-500 flex flex-col items-center text-center">
                                <div className="w-12 h-12 bg-blue-900/20 rounded-lg flex items-center justify-center mb-4 text-blue-400"><i className="ph ph-lock-key text-2xl"></i></div>
                                <h3 className="font-serif text-xl mb-2">6. Transaction Complete</h3>
                                <p className="text-sm text-[var(--text-muted)]">The secure transaction is logged on-chain, providing an immutable record of the successful exchange.</p>
                            </div>
                        </div>
                    </div>

                    {/* MOVED: The original small feature cards are now removed to make room for the detailed section above */}
                    <div className="mt-24 w-full text-left hidden">
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 w-full text-left">
                            <div className="glass-panel p-8 rounded-xl hover:border-emerald-500/30 transition duration-500"><div className="w-12 h-12 bg-emerald-900/20 rounded-lg flex items-center justify-center mb-4 text-emerald-400"><i className="ph ph-lock-key text-2xl"></i></div><h3 className="font-serif text-xl mb-2">Secure Vault</h3><p className="text-sm text-[var(--text-muted)]">Funds held in multi-sig smart contracts.</p></div>
                            <div className="glass-panel p-8 rounded-xl hover:border-blue-500/30 transition duration-500"><div className="w-12 h-12 bg-blue-900/20 rounded-lg flex items-center justify-center mb-4 text-blue-400"><i className="ph ph-lightning text-2xl"></i></div><h3 className="font-serif text-xl mb-2">Instant</h3><p className="text-sm text-[var(--text-muted)]">Settlement in seconds, not days.</p></div>
                            <div className="glass-panel p-8 rounded-xl hover:border-purple-500/30 transition duration-500"><div className="w-12 h-12 bg-purple-900/20 rounded-lg flex items-center justify-center mb-4 text-purple-400"><i className="ph ph-shield-check text-2xl"></i></div><h3 className="font-serif text-xl mb-2">Verified</h3><p className="text-sm text-[var(--text-muted)]">AI-powered fraud detection.</p></div>
                        </div>
                    </div>

                </div>
            </div>
        );

        const AuthScreen = ({ onAuthSuccess, setProcessingAction }) => {
            const [mode, setMode] = useState('login');
            const [formData, setFormData] = useState({ name: '', password: '', region: 'Global', dob: '' });
            const [error, setError] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const handleAuth = async () => {
                setError('');
                setIsLoading(true);
                if (mode === 'signup') {
                    if(!formData.name || !formData.password) { setIsLoading(false); return setError("Fields required."); }
                    const success = await dbHelper.registerUser(formData);
                    if (success) onAuthSuccess(success); else setError("Signup failed. Try again.");
                } else {
                    const userMatch = await dbHelper.authenticateUser(formData.name, formData.password);
                    if (userMatch) onAuthSuccess(userMatch); else setError("Invalid credentials.");
                }
                setIsLoading(false);
            };
            const handleAdminBypass = () => { const adminUser = { name: 'Admin', role: 'admin', uniqueHandle: '@admin001' }; onAuthSuccess(adminUser); };

            return (
                <div className="min-h-screen flex items-center justify-center p-4 relative overflow-hidden">
                    {/* Light Data Stream Background for Auth */}
                    <CryptoDataBackground />
                    
                    {/* REVERTED: Standard Theme-Aware Glass Panel for Login Box */}
                    <div className="premium-glass w-full max-w-md p-8 rounded-3xl relative z-10 border border-[var(--panel-border)] shadow-2xl">
                        <div className="text-center mb-8">
                            <div className="mb-4 flex justify-center">
                                <Logo />
                            </div>
                            <h1 className="text-3xl font-serif mt-2 tracking-wide text-[var(--text-color)]">Shieldscrow</h1>
                            <p className="text-[10px] uppercase tracking-[0.2em] text-[var(--text-muted)] mt-2">The Standard in Digital Trust</p>
                        </div>
                        <div className="flex mb-6 border-b border-[var(--panel-border)] cursor-pointer">
                            <div onClick={() => setMode('login')} className={`flex-1 pb-3 text-center text-sm font-bold uppercase transition-colors ${mode==='login'?'border-b-2 border-[var(--text-color)] text-[var(--text-color)]':'text-[var(--text-muted)] hover:text-[var(--text-color)]'}`}>Login</div>
                            <div onClick={() => setMode('signup')} className={`flex-1 pb-3 text-center text-sm font-bold uppercase transition-colors ${mode==='signup'?'border-b-2 border-[var(--text-color)] text-[var(--text-color)]':'text-[var(--text-muted)] hover:text-[var(--text-color)]'}`}>Sign Up</div>
                        </div>
                        <div className="space-y-4">
                            <input type="text" placeholder="Username" className="w-full tech-input p-3 rounded-lg transition-all focus:scale-[1.02]" onChange={e => setFormData({...formData, name: e.target.value})} />
                            {mode === 'signup' && <><input type="date" className="w-full tech-input p-3 rounded-lg" onChange={e => setFormData({...formData, dob: e.target.value})} /><CustomSelect label="Region" options={["North America", "Europe", "Asia"]} value={formData.region} onChange={v => setFormData({...formData, region: v})} /></>}
                            <input type="password" placeholder="Password" className="w-full tech-input p-3 rounded-lg transition-all focus:scale-[1.02]" onChange={e => setFormData({...formData, password: e.target.value})} />
                            {error && <p className="text-red-400 text-xs text-center bg-red-900/20 p-2 rounded border border-red-500/20">{error}</p>}
                            <button onClick={handleAuth} disabled={isLoading} className="glow-button w-full text-center mt-4 flex justify-center items-center hover:scale-[1.02] active:scale-[0.98] transition-transform">{isLoading ? <i className="ph ph-spinner animate-spin text-lg"></i> : (mode === 'login' ? 'Access Account' : 'Create Membership')}</button>
                            <div className="pt-4 text-center border-t border-[var(--panel-border)] mt-6"><button onClick={handleAdminBypass} className="text-[9px] uppercase tracking-widest text-[var(--text-muted)] hover:text-[var(--text-color)] transition">Admin Access</button></div>
                        </div>
                    </div>
                </div>
            );
        };

        const Dashboard = ({ transactions, setView, handleAction, handleChat, currentUser }) => (
            <div className="max-w-6xl mx-auto px-6 mt-12 mb-24 slide-up-enter">
                
                {/* NEW: LIVE ACTIVITY TICKER INSERTED HERE */}
                <LiveActivityTicker />

                <div className="flex justify-between items-end mb-8">
                    <h2 className="text-3xl font-serif">My Contracts</h2>
                    <button onClick={() => setView('create')} className="px-6 py-3 bg-[var(--btn-bg)] text-[var(--btn-text)] rounded-lg text-xs font-bold uppercase hover:opacity-90">+ New</button>
                </div>
                <div className="grid gap-4">
                    {/* FILTER: Only show transactions where current user is CREATOR or COUNTERPARTY */}
                    {transactions.filter(tx => tx.creatorHandle === currentUser.uniqueHandle || tx.counterpartyHandle === currentUser.uniqueHandle).map(tx => (
                        <div key={tx.id} className="glass-panel p-6 rounded-xl flex flex-col md:flex-row justify-between items-center gap-6 relative group border border-[var(--panel-border)] hover:border-[var(--text-color)] transition-all duration-300">
                            {tx.status === 'funded' && <TimerDisplay fundedAt={tx.fundedAt} />}
                            <div className="mt-6 md:mt-0">
                                <h3 className="text-xl font-serif mb-1">{tx.title}</h3>
                                <div className="text-xs uppercase tracking-widest text-[var(--text-muted)]">
                                    {tx.amount} {tx.currency}  <span className={tx.status === 'funded' ? 'text-orange-400 font-bold ml-1' : (tx.status === 'refunded' ? 'text-red-400 ml-1' : 'ml-1')}>{tx.status}</span>
                                </div>
                                <div className="text-[10px] text-[var(--text-muted)] mt-1">
                                    With: {tx.creatorHandle === currentUser.uniqueHandle ? tx.counterpartyHandle : tx.creatorHandle}
                                </div>
                            </div>
                            <div className="flex gap-3 mt-4 md:mt-0">
                                <button onClick={() => handleChat(tx)} className="px-4 py-2 border border-[var(--panel-border)] bg-[var(--input-bg)] hover:bg-[var(--panel-border)] rounded text-[10px] uppercase font-bold flex items-center gap-2">
                                    <i className="ph-fill ph-chat-text"></i> Secure Comms
                                </button>
                                {tx.status === 'created' && <button onClick={() => handleAction(tx, 'deposit')} className="px-5 py-2 bg-[var(--btn-bg)] text-[var(--btn-text)] rounded text-xs font-bold uppercase">Deposit</button>}
                                {tx.status === 'funded' && <button onClick={() => handleAction(tx, 'deliver')} className="px-5 py-2 bg-[var(--btn-bg)] text-[var(--btn-text)] rounded text-xs font-bold uppercase">Deliver</button>}
                                {tx.status === 'delivered' && <button onClick={() => handleAction(tx, 'verify_good')} className="px-5 py-2 border border-[var(--panel-border)] text-[var(--text-color)] text-xs font-bold uppercase rounded">Approve</button>}
                                {tx.status === 'refunded' && <div className="text-xs text-red-400 uppercase border border-red-900 px-3 py-1 rounded">Funds Returned</div>}
                            </div>
                        </div>
                    ))}
                    {transactions.filter(tx => tx.creatorHandle === currentUser.uniqueHandle || tx.counterpartyHandle === currentUser.uniqueHandle).length === 0 && <div className="text-center py-12 text-[var(--text-muted)] glass-panel rounded-xl border border-dashed border-[var(--panel-border)]">No active contracts found. Start a new transaction to begin.</div>}
                </div>
            </div>
        );

        const CreateTransaction = ({ setView, adminWallets, currentUser, showNotification }) => {
            // FIX: Removed the 'frequency' state to reflect the user's request
            const [form, setForm] = useState({ title: '', amount: '', role: 'buyer', currency: 'Ethereum (ETH)', counterpartyHandle: '', terms: '' });
            
            const handleSubmit = async () => {
                if (!form.title || !form.amount || !form.counterpartyHandle) return alert("Fields required");
                if (!form.counterpartyHandle.startsWith('@')) return alert("Counterparty Handle must start with @");
                
                // FIX: Handle legacy users who might not have a uniqueHandle yet
                const myHandle = currentUser.uniqueHandle || ("@" + currentUser.name.toLowerCase().replace(/\s/g, '') + "0000");

                const newTx = { 
                    title: form.title, 
                    amount: form.amount, 
                    role: form.role, 
                    currency: form.currency, 
                    status: 'created', 
                    buyerVerification: 'pending', 
                    // Removed frequency from the object
                    // Logic to assign handles based on role
                    buyerHandle: form.role === 'buyer' ? myHandle : form.counterpartyHandle,
                    sellerHandle: form.role === 'seller' ? myHandle : form.counterpartyHandle,
                    creatorHandle: myHandle,
                    counterpartyHandle: form.counterpartyHandle,
                    buyerName: form.role === 'buyer' ? currentUser.name : "Counterparty", 
                    sellerName: form.role === 'seller' ? currentUser.name : "Counterparty", 
                    terms: form.terms || "", // Ensure not undefined
                    history: [{ step: 'Created', time: new Date().toLocaleTimeString() }] 
                };
                await dbHelper.createTransaction(newTx);
                showNotification("Contract Initialized");
                setView('dashboard');
            };

            const getSymbol = (currencyStr) => { const match = currencyStr.match(/\(([^)]+)\)/); return match ? match[1] : ''; };

            return (
                // WRAPPER: Moved CryptoBackground outside the fade-in div, wrapped in fragment
                <>
                    {/* ADDED: Crypto Floating Background - Now covers full page via fixed positioning */}
                    <CryptoBackground />

                    <div className="max-w-xl mx-auto mt-12 px-6 fade-in mb-24 relative">
                        <button onClick={() => setView('dashboard')} className="mb-8 text-xs font-bold uppercase flex items-center gap-2 text-[var(--text-muted)] hover:text-[var(--text-color)] relative z-10"><i className="ph ph-arrow-left"></i> Back</button>
                        <div className="glass-panel p-8 rounded-xl border border-[var(--panel-border)] relative z-10">
                            <h2 className="text-2xl font-serif mb-6">New Contract</h2>
                            <div className="space-y-4">
                                <div className="grid grid-cols-2 gap-4">
                                    <button onClick={() => setForm({...form, role: 'buyer'})} className={`p-4 rounded border transition ${form.role === 'buyer' ? 'bg-[var(--text-color)] text-[var(--bg-color)] border-transparent' : 'bg-transparent text-[var(--text-muted)] border-[var(--input-border)]'}`}>Buyer</button>
                                    <button onClick={() => setForm({...form, role: 'seller'})} className={`p-4 rounded border transition ${form.role === 'seller' ? 'bg-[var(--text-color)] text-[var(--bg-color)] border-transparent' : 'bg-transparent text-[var(--text-muted)] border-[var(--input-border)]'}`}>Seller</button>
                                </div>
                                
                                {/* Counterparty Handle is now FIRST */}
                                <div className="relative">
                                    <input type="text" placeholder="Counterparty Handle (e.g. @rahul2391)" className="w-full luxury-input p-4 rounded-lg pl-10" onChange={e => setForm({...form, counterpartyHandle: e.target.value})} />
                                    <i className="ph ph-at absolute left-4 top-1/2 -translate-y-1/2 text-[var(--text-muted)]"></i>
                                </div>

                                {/* Asset Name is now SECOND */}
                                <input type="text" placeholder="Asset Name (e.g. Domain, NFT, Code)" className="w-full luxury-input p-4 rounded-lg" onChange={e => setForm({...form, title: e.target.value})} />

                                <div className="grid grid-cols-2 gap-4">
                                    <CustomSelect label="Network" options={Object.keys(adminWallets)} value={form.currency} onChange={v => setForm({...form, currency: v})} />
                                    <div className="relative">
                                        <label className="block text-xs font-bold uppercase text-[var(--text-muted)] mb-3">Value</label>
                                        <input type="number" className="w-full luxury-input rounded p-4 font-mono pr-12" onChange={e => setForm({...form, amount: e.target.value})} />
                                        <span className="absolute right-4 top-12 text-[var(--text-muted)] font-bold text-xs">{getSymbol(form.currency)}</span>
                                    </div>
                                </div>
                                
                                <div className="border-t border-[var(--panel-border)] pt-4 mt-2">
                                    <div className="flex justify-between items-center mb-2">
                                        <label className="text-[10px] uppercase font-bold text-[var(--text-muted)]">
                                            {form.role === 'buyer' ? 'Buyer Information / Product Details' : 'Seller Information / Product Details'}
                                        </label>
                                    </div>
                                    <textarea 
                                        className="w-full luxury-input p-4 rounded-lg h-32 font-mono text-xs leading-relaxed resize-none" 
                                        placeholder={`Enter details about the ${form.role === 'buyer' ? 'product you are buying' : 'product you are selling'}...`}
                                        value={form.terms}
                                        onChange={e => setForm({...form, terms: e.target.value})}
                                    ></textarea>
                                </div>

                                <button onClick={handleSubmit} className="glow-button w-full text-center mt-2">Initialize Contract</button>
                            </div>
                        </div>
                    </div>
                </>
            );
        };

        const AdminPanel = ({ walletsInput, setWalletsInput, transactions, handleAdminAction }) => {
            const [users, setUsers] = useState([]);
            useEffect(() => {
                const loadUsers = async () => { const data = await dbHelper.getAllUsers(); setUsers(data); };
                loadUsers();
            }, []);
            return (
                <div className="max-w-7xl mx-auto px-6 mt-16 mb-24">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
                        <div className="glass-panel p-8 rounded-lg border border-[var(--panel-border)]">
                            <div className="flex justify-between mb-6"><h2 className="text-2xl font-serif">Vault Config</h2><button onClick={() => { localStorage.setItem('admin_wallets', JSON.stringify(walletsInput)); alert("Saved"); }} className="bg-[var(--btn-bg)] text-[var(--btn-text)] px-4 py-2 text-xs font-bold uppercase rounded">Save</button></div>
                            <div className="grid grid-cols-1 gap-4">{Object.entries(walletsInput).map(([c, a]) => (<div key={c}><label className="text-[10px] uppercase text-[var(--text-muted)]">{c}</label><input value={a} onChange={e => setWalletsInput({...walletsInput, [c]: e.target.value})} className="w-full bg-transparent border-b py-1 text-[var(--text-color)] text-xs outline-none border-[var(--panel-border)]" /></div>))}</div>
                        </div>
                        <div className="glass-panel p-8 rounded-lg border border-[var(--panel-border)] overflow-hidden">
                            <div className="flex justify-between mb-6"><h2 className="text-2xl font-serif">User Registry</h2><button onClick={async () => setUsers(await dbHelper.getAllUsers())} className="text-[var(--text-muted)] hover:text-white"><i className="ph ph-arrows-clockwise"></i></button></div>
                            <div className="overflow-y-auto max-h-60">
                                <table className="w-full text-left text-xs">
                                    <thead><tr className="text-[var(--text-muted)] border-b border-[var(--panel-border)]"><th className="pb-2 uppercase">User</th><th className="pb-2 uppercase">Handle</th><th className="pb-2 uppercase">Region</th></tr></thead>
                                    <tbody className="font-mono">{users.map((u, i) => (<tr key={i} className="border-b border-[var(--panel-border)] last:border-0 hover:bg-[var(--input-bg)]"><td className="py-2 font-bold text-[var(--text-color)]">{u.name}</td><td className="py-2 text-emerald-400">{u.uniqueHandle || '-'}</td><td className="py-2 text-[var(--text-muted)]">{u.region}</td></tr>))}{users.length === 0 && <tr><td colSpan="3" className="py-4 text-center text-[var(--text-muted)]">No users found</td></tr>}</tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div className="glass-panel p-8 rounded-lg border border-[var(--panel-border)] overflow-hidden">
                        <h2 className="text-2xl font-serif mb-6">Global Transaction Monitor</h2>
                        <div className="overflow-x-auto">
                            <table className="w-full text-left text-xs">
                                <thead><tr className="text-[var(--text-muted)] border-b border-[var(--panel-border)]"><th className="pb-3 uppercase">Date</th><th className="pb-3 uppercase">Asset</th><th className="pb-3 uppercase">Handles (B / S)</th><th className="pb-3 uppercase">Amount</th><th className="pb-3 uppercase">Status</th><th className="pb-3 uppercase text-right">Arbitration</th></tr></thead>
                                <tbody className="font-mono">
                                    {transactions.map(tx => (
                                        <tr key={tx.id} className="border-b border-[var(--panel-border)] hover:bg-[var(--input-bg)] transition-colors">
                                            <td className="py-3 text-[var(--text-muted)]">{new Date(tx.dateMs).toLocaleDateString()}</td>
                                            <td className="py-3 font-bold text-[var(--text-color)]">{tx.title}</td>
                                            <td className="py-3"><div className="flex flex-col gap-1"><div className="text-emerald-400 text-[10px]">{tx.buyerHandle || 'N/A'}</div><div className="text-blue-400 text-[10px]">{tx.sellerHandle || 'N/A'}</div></div></td>
                                            <td className="py-3 text-[var(--text-color)] font-bold">{tx.amount} <span className="text-[10px] text-[var(--text-muted)] font-normal">{tx.currency.split(' ')[0]}</span></td>
                                            <td className="py-3"><span className={`uppercase text-[10px] px-2 py-1 rounded border tracking-wider ${tx.status === 'funded' ? 'border-orange-500/50 text-orange-400 bg-orange-900/20' : tx.status === 'delivered' ? 'border-blue-500/50 text-blue-400 bg-blue-900/20' : tx.status === 'released' ? 'border-emerald-500/50 text-emerald-400 bg-emerald-900/20' : tx.status === 'refunded' ? 'border-red-500/50 text-red-400 bg-red-900/20' : 'border-gray-500/50 text-gray-400'}`}>{tx.status}</span></td>
                                            <td className="py-3 text-right"><div className="flex gap-2 justify-end"><button onClick={() => handleAdminAction(tx.id, 'release')} className="text-emerald-400 hover:bg-emerald-900/30 px-3 py-1 rounded border border-emerald-500/30 hover:border-emerald-400 transition" title="Release Funds to Seller">Release</button><button onClick={() => handleAdminAction(tx.id, 'refund')} className="text-red-400 hover:bg-red-900/30 px-3 py-1 rounded border border-red-500/30 hover:border-red-400 transition" title="Refund Buyer">Refund</button></div></td>
                                        </tr>
                                    ))}
                                    {transactions.length === 0 && <tr><td colSpan="6" className="py-12 text-center text-[var(--text-muted)] uppercase tracking-widest text-xs">No active transactions found in ledger</td></tr>}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const Navbar = ({ setView, currentUser, onLogout }) => (
            <nav className="w-full h-24 border-b border-[var(--panel-border)] flex items-center justify-between px-8 md:px-16 bg-[var(--panel-bg)] backdrop-blur-md sticky top-0 z-50 transition-all duration-300">
                <div className="flex items-center gap-3 cursor-pointer group" onClick={() => setView('landing')}>
                    <div className="w-10 h-10 bg-[var(--text-color)] rounded flex items-center justify-center text-[var(--bg-color)] shadow-white"><i className="ph ph-shield-check text-2xl"></i></div>
                    <span className="text-2xl font-serif font-medium tracking-wide text-[var(--text-color)]">Shieldscrow</span>
                </div>
                <div className="flex items-center gap-8">
                    <ThemeToggle />
                    {currentUser ? (
                        <>
                            <div className="flex flex-col items-end cursor-pointer hover:opacity-80" onClick={() => setView('landing')}>
                                <span className="text-xs font-bold uppercase tracking-widest text-[var(--text-color)]">{currentUser.name}</span>
                                <span className="text-[10px] text-emerald-400 font-mono">{currentUser.uniqueHandle}</span>
                            </div>
                            <button onClick={() => setView('dashboard')} className="text-xs uppercase tracking-widest font-medium hover:text-[var(--text-muted)] text-[var(--text-color)]">Dashboard</button>
                            <button onClick={onLogout} className="text-xs uppercase tracking-widest text-red-400 hover:text-red-300">Logout</button>
                        </>
                    ) : <button onClick={() => setView('auth')} className="text-xs uppercase tracking-widest font-bold bg-[var(--text-color)] text-[var(--bg-color)] px-6 py-2 rounded hover:opacity-80">Sign In</button>}
                </div>
            </nav>
        );

        const AnimationDebugBox = ({ setProcessingAction }) => (
            <div className="fixed bottom-24 right-6 z-50 glass-panel p-4 rounded-lg flex flex-col gap-2 w-32 opacity-50 hover:opacity-100 transition-opacity">
                <div className="text-[10px] font-bold uppercase text-[var(--text-muted)] text-center mb-1">Anim Debug</div>
                <button onClick={() => { setProcessingAction({ type: 'upload', text: 'Encrypting...', status: 'uploading', progress: 0 }); let p = 0; const i = setInterval(() => { p += 5; setProcessingAction(prev => ({...prev, progress: p})); if(p >= 100) { clearInterval(i); setTimeout(() => setProcessingAction(null), 500); } }, 100); }} className="bg-blue-900/50 text-blue-400 text-[10px] px-2 py-1 rounded border border-blue-500/30 hover:bg-blue-900">Upload</button>
                <button onClick={() => { setProcessingAction({ type: 'deposit', text: 'Verifying...', status: 'processing' }); setTimeout(() => setProcessingAction(null), 3000); }} className="bg-yellow-900/50 text-yellow-400 text-[10px] px-2 py-1 rounded border border-yellow-500/30 hover:bg-yellow-900">Process</button>
                <button onClick={() => { setProcessingAction({ type: 'verify', text: 'Access Granted', status: 'success' }); setTimeout(() => setProcessingAction(null), 2000); }} className="bg-green-900/50 text-green-400 text-[10px] px-2 py-1 rounded border border-green-500/30 hover:bg-green-900">Success</button>
            </div>
        );

        const App = () => {
            const [view, setView] = useState('auth');
            const [user, setUser] = useState(null);
            const [transactions, setTransactions] = useState([]);
            const [adminWallets, setAdminWallets] = useState(DEFAULT_WALLETS);
            const [showDepositModal, setShowDepositModal] = useState(null);
            const [showDeliverModal, setShowDeliverModal] = useState(null);
            const [processingAction, setProcessingAction] = useState(null);
            const [aiResponse, setAiResponse] = useState(null);
            const [toast, setToast] = useState(null);
            const [isAdminMode, setIsAdminMode] = useState(false);
            const [isCoinAnimating, setIsCoinAnimating] = useState(false);
            const [firebaseUser, setFirebaseUser] = useState(null);
            const [activeChatTx, setActiveChatTx] = useState(null); // New state for chat

            const showNotification = (msg, type='success') => { setToast({msg, type}); setTimeout(() => setToast(null), 3000); };

            useEffect(() => {
                if (!auth) return;
                const initAuth = async () => { if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) { await signInWithCustomToken(auth, __initial_auth_token); } else { await signInAnonymously(auth); } };
                initAuth();
                const unsubscribeAuth = onAuthStateChanged(auth, (u) => { setFirebaseUser(u); });
                return () => unsubscribeAuth();
            }, []);

            useEffect(() => {
                if (!firebaseUser || !firestore) return;
                const unsubscribeTxs = onSnapshot(collection(firestore, 'artifacts', appId, 'public', 'data', 'transactions'), (snapshot) => {
                    const txs = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                    txs.sort((a, b) => b.dateMs - a.dateMs);
                    setTransactions(txs);
                }, (err) => console.log("DB Error:", err));
                return () => unsubscribeTxs();
            }, [firebaseUser]);

            useEffect(() => {
                if(transactions.length === 0) return;
                const i = setInterval(() => {
                    transactions.forEach(async (tx) => {
                        if (tx.status === 'funded' && tx.fundedAt) {
                            const elapsed = Date.now() - tx.fundedAt;
                            if (elapsed > AUTO_REFUND_TIME_MS) { await dbHelper.updateTransaction(tx.id, { status: 'refunded' }); showNotification(`Time Limit Reached: ${tx.title} Refunded`, 'error'); }
                        }
                    });
                }, 1000);
                return () => clearInterval(i);
            }, [transactions]);

            const handleAuthSuccess = (userData) => { setIsCoinAnimating(true); setTimeout(() => { setUser(userData); setView('landing'); setTimeout(() => { setIsCoinAnimating(false); }, 800); }, 800); };
            const handleLogout = () => { setUser(null); setView('auth'); };
            const handleDeliverySubmit = (link) => {
                if(!link.trim()) return alert("Link required");
                setProcessingAction({ type: 'deliver', text: 'Encrypting...', status: 'processing' });
                setTimeout(async () => {
                    await dbHelper.updateTransaction(showDeliverModal.id, { status: 'delivered', sellerDelivery: link });
                    setProcessingAction({type: 'deliver', text: 'Sent!', status: 'success'});
                    setTimeout(() => { setProcessingAction(null); setShowDeliverModal(null); }, 1500);
                }, 2000);
            };
            const handleAI = async (tx) => {
                setProcessingAction({ type: 'ai', text: 'Analyzing...', status: 'processing' });
                const advice = await callGemini(`Risk check for escrow transaction: Asset: ${tx.title}, Amount: ${tx.amount} ${tx.currency}. Is this high risk? Reply in 2 short sentences.`);
                setProcessingAction(null);
                if(advice) setAiResponse(advice); else alert("AI Unavailable");
            };
            const handleAdminAction = async (id, action) => {
                await dbHelper.updateTransaction(id, { status: action === 'release' ? 'released' : 'refunded' });
                showNotification("Settled");
            };

            if(view === 'auth' && !user && !isCoinAnimating) return <AuthScreen onAuthSuccess={handleAuthSuccess} setProcessingAction={setProcessingAction} />;

            return (
                <div className="min-h-screen">
                    <CoinTransition isActive={isCoinAnimating} />
                    {processingAction && <ActionOverlay type={processingAction.type} text={processingAction.text} status={processingAction.status} progress={processingAction.progress} />}
                    {aiResponse && <AiAdviceModal text={aiResponse} onClose={() => setAiResponse(null)} />}
                    {toast && <div className="fixed top-4 left-1/2 -translate-x-1/2 bg-[var(--btn-bg)] text-[var(--btn-text)] px-6 py-2 rounded-full z-50 font-bold border border-[var(--panel-border)]">{toast.msg}</div>}
                    <Navbar setView={setView} currentUser={user} onLogout={handleLogout} />
                    
                    <AnimationDebugBox setProcessingAction={setProcessingAction} />
                    
                    {view === 'landing' && <LandingPage setView={setView} />}
                    {view === 'dashboard' && <Dashboard transactions={transactions} setView={setView} handleAction={(tx, type) => type === 'deposit' ? setShowDepositModal(tx) : setShowDeliverModal(tx)} handleChat={setActiveChatTx} handleAI={handleAI} currentUser={user} />}
                    {view === 'create' && <CreateTransaction setView={setView} adminWallets={adminWallets} currentUser={user} showNotification={showNotification} />}
                    {view === 'admin' && <AdminPanel walletsInput={adminWallets} setWalletsInput={setAdminWallets} transactions={transactions} handleAdminAction={handleAdminAction} />}
                    
                    {showDepositModal && <DepositModal tx={showDepositModal} onClose={() => setShowDepositModal(null)} adminWallets={adminWallets} showNotification={showNotification} setProcessingAction={setProcessingAction} />}
                    {showDeliverModal && <DeliverModal tx={showDeliverModal} onClose={() => setShowDeliverModal(null)} onDeliver={handleDeliverySubmit} />}
                    
                    {/* RENDER CHAT WINDOW IF ACTIVE */}
                    {activeChatTx && <ChatWindow tx={activeChatTx} currentUser={user} onClose={() => setActiveChatTx(null)} />}

                    {user && <div className="fixed bottom-8 left-1/2 -translate-x-1/2 glass-panel p-1 rounded-full flex gap-1 z-50"><button onClick={() => {setIsAdminMode(false); setView('dashboard');}} className={`px-6 py-2 rounded-full text-[10px] font-bold uppercase ${!isAdminMode ? 'bg-[var(--btn-bg)] text-[var(--btn-text)]' : 'text-[var(--text-muted)]'}`}>Client</button><button onClick={() => {setIsAdminMode(true); setView('admin');}} className={`px-6 py-2 rounded-full text-[10px] font-bold uppercase ${isAdminMode ? 'bg-[var(--btn-bg)] text-[var(--btn-text)]' : 'text-[var(--text-muted)]'}`}>Admin</button></div>}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        window.onload = function() {
            root.render(<App />);
        };
    </script>
</body>
</html>
